= Lab: Managing Ansible Content with Private Automation Hub

[abstract]
We will create a custom Collection, publish it to a Private Automation Hub (PAH), build a custom Execution Environment (EE) from a Red Hat certified base image, and finally, run the automation from Ansible Automation Controller.

Content management is a critical component of enterprise automation. Instead of publishing and retrieving content directly from public sources, automation assets will be sourced from a local and trusted content source. This lab will guide you through the process of creating and publishing Ansible Content Collections to a Private Automation Hub, building custom Execution Environments, and integrating them with Ansible Automation Controller. 

== Learning Objectives

After completing this module, you will be able to:

* Understand the role and benefits of Private Automation Hub
* Create and publish custom Ansible Collections
* Build custom Execution Environments
* Integrate Collections with Automation Controller
* Manage content lifecycle in enterprise environments

== 1. Introduction: The Role of Private Automation Hub

A link:https://www.redhat.com/en/technologies/management/ansible/automation-hub[Private Automation Hub (PAH),window=_blank] acts as a central repository containing curated and trusted automation content. It allows you to manage, share, and control access to a curated set of Execution Environments and Ansible Content Collections.

=== 1.1: Importance of Private Automation Hub

Private Automation Hub provides several key benefits for enterprise automation:

. Centralized Control: A single source of truth for all your certified automation content.
. Security & Trust: Ensures that teams are using approved and vetted collections and EEs.
. Dependency Management: Simplifies dependency resolution by providing a private, trusted source for collections.
. Scalability: Enables the distribution of automation content across large organizations.

== 2. Lab Setup: Configuring Your Environment

First, let's configure the steps that your Dev Spaces environment needs to communicate with your Private Automation Hub.

=== 2.1: Configure Ansible to Use PAH via Environment Variables

Instead of creating an _ansible.cfg_ configuration file with your secret token that is used to communicate with PAH, we will set environment variables. This is a more secure practice for local development as it prevents tokens from being accidentally committed to source control.

==== 2.1.1: Obtaining Your PAH API Token

Utilize the following steps to obtain your PAH API token:

. Launch the link:{aap_controller_web_url}[Private Automation Hub,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Content** and click on **API Token**.
+
image::21-content-dev-ee/api-token-overview.png[API Token Overview]
+
. On the API Token page, click the **Generate token** button. Your API token will be displayed.
+
image::21-content-dev-ee/api-token-generate.png[Generate an API Token]
+
. Click the *Copy to clipboard* icon to copy it.
+
NOTE: Make sure to store the token securely, as it will not be displayed again.

==== Step 2.1.3: Set Environment Variables

In your Dev Spaces terminal, create a file containing the following variables. These will configure `ansible-galaxy` and `ansible-builder` to use your PAH instance instead of upstream to pull and push collections and execution environments.

. First, create a file in your `/projects/env/` directory with the following contents, be sure to use your PAH API token created previously:
+
NOTE: Replace #{your_api_token}# below with the personal API token you just copied from PAH.
+
[source,bash,role=execute,subs="verbatim,attributes,quotes",title="/projects/env/set_pah_vars.env"]
----
# This file contains configuration variables and is intended to be sourced, not executed.

# This is your unique token from Private Automation hub
export PAH_API_TOKEN='#{your_api_token}#'

# Set your AAP web URL used throughout the rest of the vars
export AAP_CONTROLLER_WEB_URL='{aap_controller_web_url}'

# Set the list of servers Ansible should know about
export ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'

# Configure the 'published' repository
export ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='${AAP_CONTROLLER_WEB_URL}/pulp_ansible/galaxy/published/'
export ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=${PAH_API_TOKEN}

# Configure the 'certified' repository
export ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='${AAP_CONTROLLER_WEB_URL}/pulp_ansible/galaxy/rh-certified/'
export ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=${PAH_API_TOKEN}

# Configure the 'validated' repository
export ANSIBLE_GALAXY_SERVER_VALIDATED_URL='${AAP_CONTROLLER_WEB_URL}/pulp_ansible/galaxy/validated/'
export ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=${PAH_API_TOKEN}

# Configure the 'community' repository
export ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='${AAP_CONTROLLER_WEB_URL}/pulp_ansible/galaxy/community/'
export ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=${PAH_API_TOKEN}

# Show loaded variables
printenv | grep ANSIBLE
----
+
TIP: Also create a corresponding file to clear these variables for any troubleshooting purposes:
+
[source,bash,role=execute,title="/projects/env/unset_pah_vars.env"]
----
# This is only needed to switch between upstream Automation Hub and PAH

# Clears all the following variables:
unset PAH_API_TOKEN
unset ANSIBLE_GALAXY_SERVER_LIST

unset ANSIBLE_GALAXY_SERVER_PUBLISHED_URL
unset ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN

unset ANSIBLE_GALAXY_SERVER_CERTIFIED_URL
unset ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN

unset ANSIBLE_GALAXY_SERVER_VALIDATED_URL
unset ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN

unset ANSIBLE_GALAXY_SERVER_COMMUNITY_URL
unset ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN

# Show variables - this should be empty
printenv | grep ANSIBLE
----
+
. Load these variables into your shell environment:
+
[source,bash,role=execute]
----
source /projects/env/set_pah_vars.env
----
+
[source,output,subs="verbatim,attributes,quotes"]
----
ANSIBLE_GALAXY_SERVER_COMMUNITY_URL=https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/pulp_ansible/galaxy/community/
ANSIBLE_GALAXY_SERVER_PUBLISHED_URL=https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/pulp_ansible/galaxy/published/
ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=#{your_api_token}#
ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=#{your_api_token}#
ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=#{your_api_token}#
ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=#{your_api_token}#
ANSIBLE_GALAXY_SERVER_LIST=published,certified,validated,community
ANSIBLE_GALAXY_SERVER_VALIDATED_URL=https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/pulp_ansible/galaxy/validated/
ANSIBLE_GALAXY_SERVER_CERTIFIED_URL=https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/pulp_ansible/galaxy/rh-certified/
----

== 3. Publishing our Custom Collection

=== 3.1: Prepare collection directory

This lab will prepare the `/projects/lab_collection/` directory to be published.

. Update the `galaxy.yml` file and remove `ansible.utils` from the list of `dependencies` to appear as follows:
+
[source,bash,role=execute,subs="verbatim,attributes",title="/projects/lab_collection/galaxy.yml"]
----
dependencies:  
  "ansible.windows": "*"
  "chocolatey.chocolatey": "*"
  "microsoft.iis": "*"
----
+
. Feel free to modify the rest of the file as desired, such as author and description details.

=== 3.2: Publishing Collections

Publishing a Collection makes it available in PAH for use in Automation Controller and other tools. To publish a collection, a _namespace_ must exist in PAH for which the collection can be built and then published.

==== 3.2.1: Creating namespace for collection

Create a new _Namespace_ in PAH.

. Launch the link:{aap_controller_web_url}[Private Automation Hub,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Content** and click on **Namespaces**.
+
image::21-content-dev-ee/navigate-namespaces.png[Namespaces navigation]
+
. Click **Create Namespace** to create the namespace.
. Enter `red_hat_one` for the name. The rest of the values can be left blank. Click *Create namespace*:
+
image::21-content-dev-ee/create-namespace.png[Namespace creation form]

=== 3.3: Build and Publish the Collection

Now that a namespace exists, we can build and publish our collection to PAH.

. First ensure you are at the root of the collection in `/projects/lab_collection/`
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
cd /projects/lab_collection/
----
+
. Build the collection with `ansible-galaxy`:
+
[source,bash,role=execute]
----
ansible-galaxy collection build --verbose
----
+
[source,output]
----
No config file found; using defaults
Created collection for red_hat_one.super_lab at /projects/lab_collection/red_hat_one-super_lab-1.0.0.tar.gz
----
+
. Publish the collection to Private Automation Hub
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-galaxy collection publish --server {aap_controller_web_url}/api/galaxy/ red_hat_one-super_lab-1.0.0.tar.gz --token ${PAH_API_TOKEN} --verbose
----
+
[source,output]
----
No config file found; using defaults
Publishing collection artifact '/projects/lab_collection/red_hat_one-super_lab-1.0.0.tar.gz' to cmd_arg https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/
Collection has been published to the Galaxy server cmd_arg https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/
Waiting until Galaxy import task https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/v3/imports/collections/019bc27e-b50e-70f8-bbc8-6b2590228801/ has completed
Collection has been successfully published and imported to the Galaxy server cmd_arg https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/
----
+
NOTE: You can safely ignore any warnings that may be emitted during the publishing process, but as a bonus feel free to fix them.
+
. Once your collection has been published, it must be approved before it is available for use.
. Launch the link:{aap_controller_web_url}[Private Automation Hub,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Content** and click on **Collection Approvals**.
+
image::21-content-dev-ee/collections-approvals-pending.png[Approve the Collection]
+
. The `red_hat_one.super_lab` should be listed as pending approval. Select this namespace checkbox and click the **Thumbs Up** icon all the way to the right to approve and sign the collection.
+
image::21-content-dev-ee/collections-approvals-selection.png[Select Collection to Approve]
+
. Select the _Yes, I confirm that I want to approve these 1 collections._ checkbox and click **Approve collections** button.
+
image::21-content-dev-ee/collections-approvals-approve-collection.png[Pending Approval Collection]
+
. Navigate to the **Collections** page in PAH to verify that your collection is published and available.
+
. You should see your `red_hat_one.super_lab` collection listed and available for use.
+
image::21-content-dev-ee/pah-collections.png[PAH Collections]

== 4: Syncing a Base EE from the Red Hat Registry

Before producing our own Execution Environment (EE) in subsequent steps, we'll configure PAH to pull in a certified base image from Red Hat. Since AAP images within the Red Hat Container Registry are private, we need to configure a credential within PATH to allow for the retrieval of images.

=== 4.1: Configure Remote Registry

. Launch the link:{aap_controller_web_url}[Private Automation Hub,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Content** and click on **Remote Registries**.
+
. Click the **Create remote registry** button
+
image::21-content-dev-ee/create-remote-registry.png[Create Remote Registry]
+
. Enter the following details on the _Create Remote Registry_ page:
.. _Name_: `redhat`
.. _URL_: `https://registry.redhat.io`
.. _Username_: `YOUR_REDHAT_USERNAME`
.. _Password_: `YOUR_REDHAT_PASSWORD`
.. Click **Create remote registry** to add the new registry.
+
image::21-content-dev-ee/create-remote-registry-details.png[Create Remote Registry Details]
+
NOTE: You can link:https://access.redhat.com/terms-based-registry[Create Service Account Credentials,window=_blank] in the Red Hat Customer Portal to simplify the management and access to the Red Hat Container Catalog.

Now that details related to the Red Hat Container Registry have been added, configure PAH to sync the `ee-minimal-rhel9` image 

=== 4.2: Synchronize base Execution Environment

. From the navigation menu on the left, expand **Automation Content** and click on **Execution Environments**. 
+
. Click the **Create execution environment** button.
+
image::21-content-dev-ee/create-execution-environment.png[Create Execution Environment]
+
. Enter the following details on the _Create Execution Environment_ page:
.. Name: `ansible-automation-platform-26/ee-minimal-rhel9`
.. Upstream Name: `ansible-automation-platform-26/ee-minimal-rhel9`
.. Remote Registry: Use the drop-down to select `redhat` that was just created.
.. To reduce the sync time and storage requirements, enter `latest` in the _Add tag(s) to include_ field and click **Add**
.. Click the **Create execution environment** button to create the new EE.
+
image::21-content-dev-ee/create-execution-environment-form.png[Create Execution Environments Form]
+
. Synchronize the Execution Environment into PAH from the Red Hat Container Registry.
. Next to the `ansible-automation-platform-26/ee-minimal-rhel9` Execution Environment, click the kebab menu (three vertical dots) on the right hand side of the entry and select **Sync execution environment**.
+
image::21-content-dev-ee/execution-environment-sync.png[Sync Execution Environment]
+
. Click the checkbox next to the _Yes, I confirm I want to sync these 1 execution environments_.  the box to confirm and click **Sync execution environment**.
. Click the **Sync Execution Environments** button to start the synchronization process.
+
image::21-content-dev-ee/execution-environment-confirm-sync.png[Confirm Sync Execution Environment]
+
. After the sync is complete, the `ee-minimal-rhel9` image will be available in your Private Automation Hub instance. Feel free to explore the details of the newly synchronized Execution Environment as you see fit.

=== 4.3: Synchronize required collections

. Go to *Automation Content* -> *Remotes*
. Click on the kebob (3 dots) to the right of *rh-certified* and choose the edit (pencil) icon
+
image::21-content-dev-ee/edit-certified-remote.png[Edit RH-Certified Repository]
+
. In the *Token* field, paste the token obtained in the previous lab for upstream Automation Hub
. In the *Requirements file* field, paste the contents of `/projects/lab_playbooks/collections/requirements.yml`
+
[source,yaml,role=execute]
----
collections:
  - chocolatey.chocolatey
  - ansible.windows
  - microsoft.iis
----
+
. Click *Save remote*
+
image::21-content-dev-ee/edit-certified-details.png[Edit Details]
+
. Navigate to *Automation Content* -> *Repositories*, next to *rh-certified* click the kebob (3 dots) and select *Sync repository*
+
image::21-content-dev-ee/sync-certified-repository.png[Sync Repository]
+
. Confirm in the final dialogue
+
image::21-content-dev-ee/sync-repo-confirm.png[caption="Confirm Sync", role="thumb"]

== 5: Push Collection to Repository

After we've published our collection to Private Automation Hub, the next step is to save our work into your lab's Gitea instance.

=== 5.1: Create Gitea Repository

Create a new repository in your Gitea instance to hold the collection code using the following steps:

. Navigate to your link:{gitea_console_url}[Gitea instance,window=_blank] and click the **Sign In** button on the upper right hand corner
+ 
image::21-content-dev-ee/gitea-homepage.png[Gitea Homepages]
+
. Enter the username and password using the credentials provided from the xref:environment-details.adoc[Environment Details,window=_blank] page and click the **Sign In** button
+ 
image::21-content-dev-ee/gitea-login.png[Gitea Login Page]
+
. Once authenticated, in the top left of the web interface, click on the **+** symbol and select **New Repository**.
+
image::21-content-dev-ee/gitea-navigate-new-repository.png[Navigate to new Gitea Repository]
+
. On the *New Repository* page, enter `red_hat_one_super_lab` in the *Repository Name* field.
+ 
image::21-content-dev-ee/gitea-new-repository-name.png[Gitea New Repository]
+
. Leave everything else as default and click on the button at the bottom, **Create Repository**.

image::21-content-dev-ee/gitea-create-repository.png[Gitea Create Repository]


==== 5.2: Append to the `.gitignore` file

Return to your Dev Spaces terminal. 

. Update the `.gitignore` file within the `/projects/lab_collection` directory containing the collection and append the following lines to exclude files that should not be committed to the repository.

[source,bash,role=execute,subs="verbatim,attributes",title="/projects/lab_collection/.gitignore"]
----
context/
.password
ansible.cfg
.vscode/
*.tar.gz
*.json
secrets.*
----

=== 5.3: Push collection to new repository

After an empty repository is created on your Gitea instance, the next step is to push the collection to the repository.

. Navigate to the link:{gitea_console_url}/{gitea_user}/red_hat_one_super_lab[red_hat_one_super_lab,window=_blank] repository.
. In the section _Clone this repository_, click the **Copy URL** icon on the far right to copy Gitea repository URL for the _HTTPS_ protocol option.
. Now, from within the the terminal of your Dev Spaces instance, within the `/projects/lab_collection/` directory, execute the following commands to initialize a new Git repository and push the content to the Gitea repository.
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
cd /projects/lab_collection/
git init
----
+
[source,output]
----
hint: Using 'master' as the name for the initial branch. This default branch name
hint: is subject to change. To configure the initial branch name to use in all
hint: of your new repositories, which will suppress this warning, call:
hint:
hint:   git config --global init.defaultBranch <name>
hint:
hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
hint: 'development'. The just-created branch can be renamed via this command:
hint:
hint:   git branch -m <name>
Initialized empty Git repository in /projects/lab_collection/.git/
----
+
. Change from the default of `master` to `main`:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git checkout -b main
----
+
[source,output]
----
Switched to a new branch 'main'
----
+
. Stage all the collection files
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git add --all
----
+
. Commit this to git
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git commit -m "Initial collection"
----
+
[source,output]
----
[main (root-commit) 13c7c5d] Initial collection
 88 files changed, 2326 insertions(+)
 create mode 100644 .gitignore
 ...
 create mode 100644 roles/log_shipper/README.md
 create mode 100644 roles/log_shipper/defaults/main.yml
 create mode 100644 roles/log_shipper/files/.keep
 create mode 100644 roles/log_shipper/handlers/main.yml
 create mode 100644 roles/log_shipper/meta/argument_specs.yml
 create mode 100644 roles/log_shipper/meta/main.yml
 create mode 100644 roles/log_shipper/tasks/chocolatey.yml
 create mode 100644 roles/log_shipper/tasks/filebeat.yml
 create mode 100644 roles/log_shipper/tasks/main.yml
 create mode 100644 roles/log_shipper/tasks/prerequisites.yml
 create mode 100644 roles/log_shipper/templates/.keep
 create mode 100644 roles/log_shipper/tests/inventory
 create mode 100644 roles/log_shipper/vars/main.yml
 ...
 create mode 100644 roles/web_server/README.md
 create mode 100644 roles/web_server/defaults/main.yml
 create mode 100644 roles/web_server/files/.keep
 create mode 100644 roles/web_server/files/index.html.j2
 create mode 100644 roles/web_server/handlers/main.yml
 create mode 100644 roles/web_server/meta/argument_specs.yml
 create mode 100644 roles/web_server/meta/main.yml
 create mode 100644 roles/web_server/tasks/main.yml
 create mode 100644 roles/web_server/tasks/setup.yml
 create mode 100644 roles/web_server/tasks/validate.yml
 create mode 100644 roles/web_server/tasks/website.yml
 create mode 100644 roles/web_server/templates/.keep
 create mode 100644 roles/web_server/tests/inventory
 create mode 100644 roles/web_server/vars/main.yml
 ...
----
+
TIP: Ensure the roles created earlier are included
+
. Add the gitea remote
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git remote add origin {gitea_console_url}/{gitea_user}/red_hat_one_super_lab.git<1>
----
<1> This is the URL copied in step *2.* above.
+
. Push the files
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git push -u origin main
----
+
NOTE: Since the repository requires authentication, you will be prompted to enter your Gitea username and password at the top of the Dev Spaces window.
+
image::21-content-dev-ee/devspaces-git-auth.png[Gitea Repository Containing Collection Content]
+
[source,output]
----
Enumerating objects: 117, done.
Counting objects: 100% (117/117), done.
Delta compression using up to 16 threads
Compressing objects: 100% (88/88), done.
Writing objects: 100% (117/117), 35.90 KiB | 2.39 MiB/s, done.
Total 117 (delta 8), reused 0 (delta 0), pack-reused 0 (from 0)
remote: Resolving deltas: 100% (8/8), done.
remote: . Processing 1 references
remote: Processed 1 references in total
To {gitea_console_url}/{gitea_user}/red_hat_one_super_lab.git
 * [new branch]      main -> main
branch 'main' set up to track 'origin/main'.
----
+
. Refresh the `red_hat_one_super_lab` page within the Gitea UI to confirm that the collection has been published successfully.
+
image::21-content-dev-ee/gitea-repository.png[Dev Spaces Git Authentication]
. This repository will be referenced in later labs.

== 6: Building a Custom Execution Environment

Now, we'll define and build a custom Execution Environment (EE) that uses our synced minimal image and our custom collection.

=== 6.1: Define the Execution Environment

Create a file named `execution-environment.yml` at the root of the `lab_collection` directory with the following content.

[source,yaml,title="/projects/lab_collection/execution-environment.yml",role=execute,subs="verbatim,attributes"]
----
---
version: 3

images:
  base_image:
    name: aap-aap.{openshift_cluster_ingress_domain}/ansible-automation-platform-26/ee-minimal-rhel9:latest

dependencies:
  ansible_core:
    package_pip: ansible-core==2.16.14
  galaxy:
    collections:
      - name: red_hat_one.super_lab
        version: 1.0.0
options:
  package_manager_path: /usr/bin/microdnf

additional_build_steps:
  prepend_galaxy:
    - ARG TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/rh-certified/'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=${TOKEN}
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/validated/'
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=${TOKEN}
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='{aap_controller_web_url}/pulp_ansible/galaxy/community/'
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=${TOKEN}
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/published/'
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=${TOKEN}
----

=== 6.2: Build and Publish the Execution Environment

Login to your PAH container registry, build the custom Execution Environment, and push the resulting image to your PAH instance using the following commands:

. Login to to PAH container registry:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
# Log in to your PAH container registry with your AAP user credentials
podman login aap-aap.{openshift_cluster_ingress_domain}
----
+
[source,output]
----
Username: admin
Password: 
Login Succeeded!
----
+
. Build the Execution Environment. It will pull the base from PAH, then add our content:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-builder build --tag my-pah-ee:1.0 --build-arg TOKEN=${PAH_API_TOKEN} --verbosity 1
----
+
NOTE: The `${PAH_API_TOKEN}` environment variable was set previously containing the value of the API Token from PAH. Set this variable once again if your terminal session has been restarted via the `/projects/env/set_pah_vars.env` file.
+
[source,output,subs="verbatim,quotes,callouts"]
----
Running command:
  podman build -f context/Containerfile -t my-pah-ee:1.0 --build-arg=TOKEN=*_removed_* context<1>
Complete! The build context can be found at: /projects/lab_collection/context
----
<1> Token is passed from the CLI and used in the build process, but removed in this output for security.
+
. Tag and push the image to your PAH registry:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
podman tag localhost/my-pah-ee:1.0 aap-aap.{openshift_cluster_ingress_domain}/my-pah-ee:1.0
----
+
. Push the newly build Execution Environment image to PAH:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
podman push aap-aap.{openshift_cluster_ingress_domain}/my-pah-ee:1.0
----
+
[source,output]
----
Getting image source signatures
Copying blob 8d7002e6f5a3 done   | 
Copying blob deebe6823303 done   | 
Copying blob 07f03aaea22a done   | 
Copying blob 53cd9a4d07b1 done   | 
Copying blob 8e88ef553a8b done   | 
Copying blob aa5eefe60148 skipped: already exists  
Copying blob e6db9dbd3832 done   | 
Copying blob 8693db968fb4 done   | 
Copying blob 79e63427b552 done   | 
Copying blob 5f70bf18a086 done   | 
Copying blob 1903d60376d1 done   | 
Copying blob f129e8539ece done   | 
Copying blob 972bd7578ec1 done   | 
Copying config 2ee9809c70 done   | 
Writing manifest to image destination
----
+
. Return to the AAP controller and select *Automation Content* -> *Execution Environments*. Verify your EE is present:
+
image::21-content-dev-ee/collection-uploaded.png[Confirm Collection Upload]

== 7: Adding a Custom Filter Plugin

Now that we have a working EE, let's iterate by adding a custom link:https://docs.ansible.com/ansible/latest/plugins/filter.html[Filter plugin,window=_blank] to our collection.

=== 7.1: Create the Custom Filter Plugin

Create a file at `plugins/filter/cowsay_filter.py` with the following content:

[source,python,title="/projects/lab_collection/plugins/filter/cowsay_filter.py",role=execute,subs="verbatim,attributes"]
----
from __future__ import (absolute_import, division, print_function)
__metaclass__ = type

DOCUMENTATION = '''
    name: cowsay
    short_description: A filter to wrap text in a cowsay bubble.
    description:
        - This filter takes a string and returns it formatted by the cowsay library.
    requirements:
      - The `cowsay` python library must be installed.
'''

try:
    import cowsay
except ImportError:
    cowsay = None

def cowsay_filter(text):
    if not cowsay:
        raise AnsibleFilterError("The 'cowsay' Python library is not installed. Cannot use filter.")
    return cowsay.cow(text)

class FilterModule(object):
    def filters(self):
        return {
            'cowsay': cowsay_filter
        }
----

=== Step 7.2: Update the EE Definition for the Plugin Dependency

Our new plugin requires the link:https://pypi.org/project/cowsay/[cowsay Python library,window=_blank], and we need to ensure our EE is pulling the new version of our collection. Modify the `execution-environment.yml` to include both changes.

[source,yaml,title="/projects/lab_collection/execution-environment.yml",role=execute,subs="verbatim,attributes,callouts,quotes"]
----
---
version: 3

images:
  base_image:
    name: aap-aap.{openshift_cluster_ingress_domain}/ansible-automation-platform-26/ee-minimal-rhel9:latest

dependencies:
  ansible_core:
    package_pip: ansible-core==2.16.14
  galaxy:
    collections:
      - name: red_hat_one.super_lab
        version: 1.0.1<1>
  python:<2>
    - cowsay
options:
  package_manager_path: /usr/bin/microdnf

additional_build_steps:
  prepend_galaxy:
    - ARG TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_LIST='published,certified,validated,community'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/rh-certified/'
    - ENV ANSIBLE_GALAXY_SERVER_CERTIFIED_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/validated/'
    - ENV ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_URL='{aap_controller_web_url}/pulp_ansible/galaxy/community/'
    - ENV ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN=$TOKEN
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_URL='{aap_controller_web_url}/pulp_ansible/galaxy/published/'
    - ENV ANSIBLE_GALAXY_SERVER_PUBLISHED_TOKEN=$TOKEN
----
<1> Increment the collection version.
<2> Add the `python` section to include the `cowsay` dependency.

=== 7.3: Increment Collection nad Version and Republish

Now, we publish a new version of the collection and a new version of the EE that includes the updated collection and dependency.

. First, edit `galaxy.yml` and change the version from `1.0.0` to `1.0.1`.
. Rebuild the collection:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-galaxy collection build
----
+
[source,output]
----
No config file found; using defaults
Created collection for red_hat_one.super_lab at /projects/lab_collection/red_hat_one-super_lab-1.0.1.tar.gz
----
+
. Publish the new version:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-galaxy collection publish --server {aap_controller_web_url}/api/galaxy/ red_hat_one-super_lab-1.0.1.tar.gz --token ${PAH_API_TOKEN} --verbose
----
+
[source,output]
----
No config file found; using defaults
Publishing collection artifact '/projects/lab_collection/red_hat_one-super_lab-1.0.1.tar.gz' to cmd_arg https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/
Collection has been published to the Galaxy server cmd_arg https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/
Waiting until Galaxy import task https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/v3/imports/collections/019bc7a3-5699-720a-b074-40f6be11761e/ has completed
Collection has been successfully published and imported to the Galaxy server cmd_arg https://aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/api/galaxy/
----
+
. Approve collection in the PAH web interface as described previously.
. Verify new version in PAH:
+
image::21-content-dev-ee/collection-verify-new-version.png[Verify New Collection Version]

=== 7.4: Build and push new Execution Environment

Finally, build and push the new EE version:

. Rebuild a new execution environment version:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-builder build --tag my-pah-ee:1.1 --build-arg TOKEN=${PAH_API_TOKEN} --verbosity 1
----
+
[source,output]
----
File context/_build/requirements.yml had modifications and will be rewritten
Complete! The build context can be found at: /projects/lab_collection/context
----
+
. The new image will be available locally:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
podman images
----
+
[source,output]
----
bash-5.1$ podman images
REPOSITORY                                                                                             TAG         IMAGE ID      CREATED         SIZE
localhost/my-pah-ee                                                                                    1.1         81a91a3d03da  18 minutes ago  365 MB
<none>                                                                                                 <none>      88d70b0fdb27  20 minutes ago  367 MB
<none>                                                                                                 <none>      162996cdd48c  20 minutes ago  365 MB
localhost/my-pah-ee                                                                                    1.0         40aee109e507  46 minutes ago  365 MB
<none>                                                                                                 <none>      0cd7b6b90811  47 minutes ago  367 MB
<none>                                                                                                 <none>      749921c9ce7b  48 minutes ago  365 MB
aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/ansible-automation-platform-26/ee-minimal-rhel9  latest      9d130a29338c  4 weeks ago     341 MB
----
+
. Tag the new EE:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
podman tag localhost/my-pah-ee:1.1 aap-aap.{openshift_cluster_ingress_domain}/my-pah-ee:1.1
----
+
. You can verify by listing images again:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
podman images
----
+
[source,output,subs="quotes"]
----
REPOSITORY                                                                                             TAG         IMAGE ID      CREATED         SIZE
#aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/my-pah-ee                                        1.1         81a91a3d03da  22 minutes ago  365 MB#
localhost/my-pah-ee                                                                                    1.1         81a91a3d03da  22 minutes ago  365 MB
<none>                                                                                                 <none>      88d70b0fdb27  24 minutes ago  367 MB
<none>                                                                                                 <none>      162996cdd48c  25 minutes ago  365 MB
localhost/my-pah-ee                                                                                    1.0         40aee109e507  50 minutes ago  365 MB
<none>                                                                                                 <none>      0cd7b6b90811  52 minutes ago  367 MB
<none>                                                                                                 <none>      749921c9ce7b  52 minutes ago  365 MB
aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/ansible-automation-platform-26/ee-minimal-rhel9  latest      9d130a29338c  4 weeks ago     341 MB
----
+
. Publish the new EE version:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
podman push aap-aap.{openshift_cluster_ingress_domain}/my-pah-ee:1.1
----
+
[source,output]
----
Getting image source signatures
Copying blob e9b18b42db30 done   | 
Copying blob 3e44b8c037a4 done   | 
Copying blob c644513b7c21 done   | 
Copying blob 03c21ed8e101 done   | 
Copying blob eaaedab2167d done   | 
Copying blob e189a7d08ffb done   | 
Copying blob aa5eefe60148 skipped: already exists  
Copying blob 4b8fa9ef238e done   | 
Copying blob 25e49599071c done   | 
Copying blob 5f70bf18a086 done   | 
Copying blob 9f1b4907d130 done   | 
Copying blob b026c973af3b done   | 
Copying blob 0f9da8a96a25 done   | 
Copying config 81a91a3d03 done   | 
----
+
. Verify by navigating in AAP controller to *Automation Content* -> *Execution Environments* -> *my-pah-ee* -> *Images*
+
image::21-content-dev-ee/execution-environment-versions.png[View EE Versions]

== 8: Test content in Dev Spaces

Now that both the collection and Execution Environment have been created and published to Private Automation hub, we'll create a playbook to use the filter contained within the `red_hat_one.super_lab` collection.

=== 8.1: Create a Playbook

Since we already have a plabyook directory at `/projects/lab_playbooks/` we will use this.

. Create a new playbook in a file named `test_pah_ee.yml`. This playbook uses the `debug` module to print a message that has been formatted by our custom `cowsay` filter:
+
[source,yaml,title="/projects/lab_playbooks/test_pah_ee.yml",role=execute,subs="verbatim,attributes"]
----
---
- name: Test custom filter from Private Automation Hub
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Print a message using the cowsay filter
      ansible.builtin.debug:
        msg: "{{ 'Hello from my custom filter!' | red_hat_one.super_lab.cowsay }}"
...
----

=== 8.2: Update Collections requirements

Since this playbook requires the custom collection, let's add it to the requirements file:

[source,yaml,title="/projects/lab_playbooks/collections/requirements.yml",role=execute,subs="verbatim,attributes"]
----
collections:
  - chocolatey.chocolatey
  - ansible.windows
  - microsoft.iis
  - red_hat_one.super_lab<1>
----
<1> Add the custom collection here. Note that due to the symlink we created earlier, this isn't required, but will be when running on AAP.

=== 8.3: Run playbook

. Attempt to run this locally. It will fail. Do you know why?
+
[source,yaml,role=execute,subs="verbatim,attributes"]
----
cd /projects/lab_playbooks/
ansible-playbook test_pah_ee.yml
----
+
[source,output]
----
ansible-playbook [core 2.19.3]<1>
  config file = /projects/lab_playbooks/ansible.cfg
  configured module search path = ['/home/user/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.11/site-packages/ansible
  ansible collection location = /home/user/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible-playbook
  python version = 3.11.13 (main, Aug 21 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-11)] (/usr/bin/python3.11)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
Using /projects/lab_playbooks/ansible.cfg as config file
[WARNING]: Found both group and host with same name: windows
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAY [Test custom filter from Private Automation Hub] *****************************************************************************************************************************************************

TASK [Print a message using the cowsay filter] ************************************************************************************************************************************************************
task path: /projects/lab_playbooks/test_pah_ee.yml:8
[ERROR]: Task failed: Finalization of task args for 'ansible.builtin.debug' failed: Error while resolving value for 'msg': The filter plugin 'red_hat_one.super_lab.cowsay' failed: name 'AnsibleFilterError' is not defined

Task failed.
Origin: /projects/lab_playbooks/test_pah_ee.yml:8:7

6
7   tasks:
8     - name: Print a message using the cowsay filter
        ^ column 7

<<< caused by >>>

Finalization of task args for 'ansible.builtin.debug' failed.
Origin: /projects/lab_playbooks/test_pah_ee.yml:9:7

7   tasks:
8     - name: Print a message using the cowsay filter
9       ansible.builtin.debug:
        ^ column 7

<<< caused by >>>

Error while resolving value for 'msg': The filter plugin 'red_hat_one.super_lab.cowsay' failed: name 'AnsibleFilterError' is not defined
Origin: /projects/lab_playbooks/test_pah_ee.yml:10:14

 8     - name: Print a message using the cowsay filter
 9       ansible.builtin.debug:
10         msg: "{{ 'Hello from my custom filter!' | red_hat_one.super_lab.cowsay }}"
                ^ column 14

fatal: [localhost]: FAILED! => {"msg": "Task failed: Finalization of task args for 'ansible.builtin.debug' failed: Error while resolving value for 'msg': The filter plugin 'red_hat_one.super_lab.cowsay' failed: name 'AnsibleFilterError' is not defined"}

PLAY RECAP ************************************************************************************************************************************************************************************************
localhost                  : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0  
----
<1> Notice this version of `ansible-core` vs what is in the execution environment.
+
IMPORTANT: Using `ansible-playbook` will merely use the local environment, not the execution environment we just created. In order to utilize it properly, we must use `ansible-navigator`.
+
. This time use `ansible-navigator` and specify the execution environment:
+
[source,yaml,role=execute,subs="verbatim,attributes"]
----
ansible-navigator --execution-environment-image aap-aap.apps.cluster-gtjkm.dynamic.redhatworkshops.io/my-pah-ee:1.1 run test_pah_ee.yml  --mode stdout
----
+
[source,output]
----
ansible-playbook [core 2.16.14]<1>
  config file = /projects/lab_playbooks/ansible.cfg
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.11/site-packages/ansible
  ansible collection location = /root/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible-playbook
  python version = 3.11.13 (main, Aug 21 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-11)] (/usr/bin/python3)
  jinja version = 3.1.6
  libyaml = True
Using /projects/lab_playbooks/ansible.cfg as config file
[WARNING]: Found both group and host with same name: windows
Skipping callback 'awx_display', as we already have a stdout callback.
Skipping callback 'default', as we already have a stdout callback.
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAYBOOK: test_pah_ee.yml ******************************************************
1 plays in /projects/lab_playbooks/test_pah_ee.yml

PLAY [Test custom filter from Private Automation Hub] **************************

TASK [Print a message using the cowsay filter] *********************************
task path: /projects/lab_playbooks/test_pah_ee.yml:8
  ____________________________
| Hello from my custom filter! |
  ============================
                            \
                             \
                               ^__^
                               (oo)\_______
                               (__)\       )\/\
                                   ||----w |
                                   ||     ||<2>
ok: [localhost] => {
    "msg": ""
}

PLAY RECAP *********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
----
<1> Notice this supported version of `ansible-core`
<2> Moo! It worked!


== 9: Integration with Automation Controller

Now that we have confirmed the execution environment and custom filter work, let's bring everything together in AAP.

=== 9.1: Push Project Files to Git

With the changes to incorporate the updated collection (filter plugin and version) and the Execution Environment, publish all of the changes to your git repository.

. Navigate to the link:{gitea_console_url}[Gitea instance,window=_blank] and create a new repository called `lab_playbooks`
. Copy the URL to clone this repository
. Return to Dev Spaces adn initialize the `lab_playbooks` directory
+
[source,bash,role=execute,subs="verbatim,attributes",title="/projects/lab_playbooks/"]
----
git init
----
+
[source,output]
----
hint: Using 'master' as the name for the initial branch. This default branch name
hint: is subject to change. To configure the initial branch name to use in all
hint: of your new repositories, which will suppress this warning, call:
hint:
hint:   git config --global init.defaultBranch <name>
hint:
hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
hint: 'development'. The just-created branch can be renamed via this command:
hint:
hint:   git branch -m <name>
Initialized empty Git repository in /projects/lab_playbooks/.git/
----
+
. Change to `main` per best practices:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git checkout -b main
----
+
[source,output]
----
Switched to a new branch 'main'
----
+
. Add specific relevant files (not all of the scaffold files):
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git add site.yml test_pah_ee.yml collections/requirements.yml
----
+
. Next, add the new remote:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git remote add origin {gitea_console_url}/{gitea_user}/lab_playbooks.git
----
+
. Finally, commit them to the new repository:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git commit -m "Initial commit of playbook files"
----
+
[source,output]
----
[main (root-commit) 14e8a8e] Initial commit of playbook files
 4 files changed, 41 insertions(+)
 create mode 100644 collections/requirements.yml
 create mode 100644 site.yml
 create mode 100644 test_pah_ee.yml
----
+
. Lastly, push commit to the new repository:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
git push origin main
----
+
[source,output]
----
Enumerating objects: 6, done.
Counting objects: 100% (6/6), done.
Delta compression using up to 16 threads
Compressing objects: 100% (5/5), done.
Writing objects: 100% (6/6), 795 bytes | 795.00 KiB/s, done.
Total 6 (delta 0), reused 0 (delta 0), pack-reused 0 (from 0)
remote: . Processing 1 references
remote: Processed 1 references in total
To https://gitea.apps.cluster-gtjkm.dynamic.redhatworkshops.io/user1/lab_playbooks.git
 * [new branch]      main -> main
----

=== 9.2: Create a Credential for Hub Container Registry

First, create a new credential in Automation Controller to allow it to pull the custom Execution Environment from Private Automation Hub.

. Launch the link:{aap_controller_web_url}[Automation Controller,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Execution** and expand **Infrastructure** and click on **Credentials**.
+
image::21-content-dev-ee/automation-controller-credentials-overview.png[Navigate to Credentials]
+
. Click **Create credential** to add a new credential.
+
image::21-content-dev-ee/automation-controller-create-credential.png[Create Credentials]
+
. Enter the following details on the _Create Credential_ page:
.. Name: `Hub`
.. Credential type: `Container Registry`
.. Authentication URL: `aap-aap.{openshift_cluster_ingress_domain}`
.. Username: `{aap_controller_admin_user}`
.. Password: `{aap_controller_admin_password}`
.. Verify SSL: Checked
. Click **Create credential** to save the new credential.

image::21-content-dev-ee/automation-controller-create-credential-dialog.png[Create Credentials Dialog]

=== 9.3: Create a Credential for the Git Repository

Next, create a new credential to retrieve the source code from the Gitea repository.

. From the Credentials page in Automation Controller, click **Create credential** once again to add a new credential.
+
image::21-content-dev-ee/automation-controller-create-credential-2.png[Create Credentials]
+
. Enter the following details on the _Create Credential_ page:
.. Name: `Gitea`
.. Credential type: `Source Control`
.. Username: `{gitea_user}`
.. Password: `{gitea_password}`
. Click **Create credential** to save the new credential.

image::21-content-dev-ee/automation-controller-create-credential-git-dialog.png[Create Credentials Dialog]

=== 9.4: Add the Execution Environment to Controller

Next, add the custom Execution Environment that we published previously to Automation Controller.

. From the navigation menu on the left, expand **Automation Execution** and expand **Infrastructure** and click on **Execution Environments**.
+
image::21-content-dev-ee/automation-controller-ee-overview.png[Navigate to Execution Environments]
+
. Click **Create execution environment** to add a new execution environment.
+
image::21-content-dev-ee/automation-controller-create-ee.png[Create Execution Environment]
+
. Enter the following details on the _Create Execution Environment_ page:
.. Name: `My Custom PAH EE`
.. Image URL: `aap-aap.{openshift_cluster_ingress_domain}/my-pah-ee:1.1`
.. Registry Credential: Select the `Hub` credential created previously.
. Click **Create execution environment** to create the new EE.

image::21-content-dev-ee/automation-controller-create-ee-dialog.png[Create Execution Environment Dialog]

=== 9.5: Create a Project

Create a new link:https://docs.ansible.com/ansible-tower/latest/html/userguide/projects.html[Project,window=_blank] in Automation Controller that points to your Git repository containing the playbook.

. From the navigation menu on the left, expand **Automation Execution** and click on **Projects**.
+
image::21-content-dev-ee/automation-controller-projects-overview.png[Navigate to Projects]
+
. Click **Create project** to add a new project.
+
image::21-content-dev-ee/automation-controller-create-project.png[Create Project]
+
. Enter the following details on the _Create Project_ page:
.. Name: `Custom Collection"
.. Organization: `Default`
.. Source Control Type: `Git`
.. Source control URL: `{gitea_console_url}/{gitea_user}/red_hat_one_super_lab.git`
.. Source code credential: Select the `Gitea` credential created previously.
. Click **Create project** to create the new Project.

image::21-content-dev-ee/automation-controller-create-project-dialog.png[Create Project Dialog]

Confirm that the project has been synced successfully by looking _Success_ underneath _Last job status_.

image::21-content-dev-ee/automation-controller-sync-project.png[Project Sync Status]

=== 9.6: Create a Job Template

With the Execution Environment and Project created, the final step is to create a Job Template that uses both components.

. From the navigation menu on the left, expand **Automation Execution** and click on **Templates**.
+
image::21-content-dev-ee/automation-controller-templates-overview.png[Navigate to Templates]
+
. Click the **Create template** dropdown and select **Create job template**.
+
image::21-content-dev-ee/automation-controller-create-job-template.png[Create Job Template]
+
. Enter the following details on the _Create job template_ page:
.. Name: `Test Custom Cowsay Filter`
.. Inventory: `super-lab`
.. Project: `Lab Playbooks`
.. Playbook: `playbooks/test_pah_ee.yml`
.. Execution Environment: `My Custom PAH EE`
. Click **Create job template** to create the new Job Template.

image::21-content-dev-ee/automation-controller-create-job-template-dialog.png[Create Job Template Dialog]

=== 9.7: Launch the Job Template and Verify

Now that the Job Template has been created, launch the _Test Custom Cowsay Filter_ and verify that the custom filter is working as expected.

. From the _Test Custom Cowsay Filter_ Job Template details page, click the **Launch template** button on the upper right hand side.

image::21-content-dev-ee/automation-controller-launch-job-template.png[Launch Job Template]

Monitor the status of the job until it completes successfully displaying the output of the cowsay filter similar to the following:

image::21-content-dev-ee/automation-controller-job-template-success.png[Job Template Success]

== 10: Collections Management

The final exercise in this lab is to customize the content sources from link:https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5/html-single/managing_automation_content/index#proc-create-remote_remote-management[Remote Automation Hub / Ansible Galaxy instances,window=_blank] into Private Automation Hub. To support lab exercises later in this bootcamp, we will specify additional collections to be synchronized.

=== 10.1: Update Community Remote

. From the navigation menu on the left, expand **Automation Content** and click on **Remotes**.
+
image::21-content-dev-ee/remotes-overview.png[Remotes Navigation]
+
. Click the pencil icon to edit the `community` remote.
+
image::21-content-dev-ee/remotes-edit-community.png[Edit Community Remote]
+
. Paste the following into the _Requirements file_ field to specify additional collections to be synced:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
collections:
  - name: containers.podman
  - name: community.postgresql
----
+
. Click **Save remote** to apply the changes.

=== 10.2: Add Validated Remote

Create a new remote for the `validated` collections repository. A token for Red Hat Automation Hub is required to access this repository.

. Navigate to Red Hat Automation Hub and click link:https://console.redhat.com/ansible/automation-hub/token[here,window=_blank] to generate a token
. Click **Load token** to generate a new token and copy it to your clipboard.
+
image::21-content-dev-ee/load-automation-hub-token.png[Load Automation Hub Token]
+
. From the Remotes page in Private Automation Hub, click **Create remote**.
+
image::21-content-dev-ee/remotes-create-remote.png[Create Remote]
+
. Enter the following details on the _Create remote_ page:
.. Name: `validated`
.. Server URL: `https://console.redhat.com/api/automation-hub/content/validated/`
.. SSO URL: `https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token`
.. Token: `<The token copied previously from Red Hat Automation Hub>`
. Click **Create remote** to create the new Remote.

image::21-content-dev-ee/remotes-add-remote.png[Add Remote]

Now that the `validated` remote has been created, update the _validated_ repository to reference the newly created remote.

. From the navigation menu on the left, expand **Automation Content** and click on **Repositories**.
+
image::21-content-dev-ee/repositories-overview.png[Add Remote]
+
. Edit the _validated_ repository by selecting the pencil icon
+
image::21-content-dev-ee/repositories-edit-validated.png[Edit Validated Repository]
+
. Update the `Remote` field by selecting `validated` from the drop down.
. Click **Save repository** to update the repository.

image::21-content-dev-ee/repositories-update-validated.png[Updated Validated Repository]

=== 10.3: Update RH-Certified Remote

Now that you have a Red Hat Automation Hub token, update the `rh-certified` remote to use this value as well.

. From the Remotes page in Private Automation Hub, edit the `rh-certified` remote by selecting the pencil icon.
+
image::21-content-dev-ee/remotes-edit-rh-certified.png[Edit RH-Certified Remote]
+
. Update the _Token_ field by pasting the token copied previously from Red Hat Automation Hub.
. Click **Save remote** to apply the changes.
  
image::21-content-dev-ee/remotes-update-rh-certified.png[Update RH-Certified Remote]

=== 10.4: Sync Repositories

Finally, synchronize the `rh-certified`, `validated`, and `community` repositories to pull in the new collections within the _Repositories_ page.

. From the navigation menu on the left, expand **Automation Content** and click on **Repositories**.
+
. Next to the `community` repository, click the kebab menu (three vertical dots) on the right hand side of the entry and select **Sync repository**.
+
image::21-content-dev-ee/sync-repository.png[Sync Repository]
+
. Repeat the above steps to sync the `rh-certified` and `validated` repositories as well.

NOTE: Syncing the _rh-certified_ collections will take some time. You can monitor the progress, but it will not impact the next set of labs in this bootcamp.

== Conclusion

Congratulations! You have successfully mastered the complete lifecycle of managing Ansible content in enterprise environments:

* **Environment Setup**: Configured your local environment to connect to a Private Automation Hub
* **Content Creation**: Built and published custom collections with advanced functionality (including filter plugins)
* **Environment Management**: Created custom Execution Environments with specific toolsets and dependencies
* **Hub Integration**: Configured Private Automation Hub for content distribution and management
* **Controller Integration**: Connected Automation Controller with custom content and environments
* **End-to-End Validation**: Verified the complete automation workflow from development to execution

This foundation enables you to create, manage, and distribute automation content at enterprise scale while maintaining security, compliance, and governance standards. The skills learned here are essential for managing automation in large organizations where content needs to be curated, controlled, and distributed efficiently.

== Helpful Links

For additional reference and deeper learning on managing Ansible content:

. https://docs.ansible.com/ansible/latest/galaxy/user_guide.html[Ansible Galaxy User Guide]
. https://docs.ansible.com/ansible/latest/collections_guide/index.html[Ansible Collections Guide]
. https://ansible.readthedocs.io/projects/builder/[Ansible Builder Documentation]
. https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5/html/using_automation_hub/index[Private Automation Hub Documentation]
