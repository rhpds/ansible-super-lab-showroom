= Lab: Content for Managing Windows Servers

[abstract]
In this lab we will develop a custom Ansible collection to manage a Windows server in our lab that will represent an example enterprise environment. We will build the content a piece at a time until the full collection is ready to be deployed. The server will be configured to run a custom website, have chocolatey software manager installed, and filebeat installed and configured.

== Learning Objectives

After completing this module, you will be able to:

. Connect and check connectivity to Windows servers from AAP
. Use `ansible.windows` and `microsoft.iis` collections
. Ensure prerequisites are installed
. Install and use Chocolatey
. Install and configure Filebeat

== 1: Managing Windows Hosts

Ansible can use a variety of connectivity options to connect to Windows. In this lab a Windows 2019 Server has been configured using `psrp` to connect. See the link:https://docs.ansible.com/projects/ansible/latest/os_guide/intro_windows.html[Ansible documentation] for full details.

=== 1.1: Validate Connectivity to Windows host

The Windows server has been configured as a host in an inventory called **super-lab**. Verify in AAP:

. Launch the link:{aap_controller_web_url}[Ansible Automation Platform,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Execution** and click on **Infrastructure**.
. Under **Infrastructure** select **Inventories** which should contain an inventory called **super-lab**
+
image::20-content-windows/aap_inventories.png[AAP Inventories]
+
. Select **super-lab**
. Select **Hosts** in the top menu
. A host called **windows** will be displayed
. Select the checkbox in front of **windows** and choose **Run command** in the top middle of the screen
+
image::20-content-windows/aap_run_command.png[Run Command]
+
. For **Module** choose **win_ping** from the drop-down then **Next**
+
image::20-content-windows/aap_win_ping.png[Module]
+
. For **Execution Environment** just choose **Next** without a selection, it will use the default EE
. For **Credential** select **Windows** then **Next**
+
image::20-content-windows/aap_run_command_credential.png[Credential]
+
. Finally, choose **Finish**. The job will run and you will be taken to the **Jobs** section
. After a few seconds a result will display which should resemble this output:
+
image::20-content-windows/aap_run_command_results.png[Results]

=== 1.2: Review Connectivity Details

In the previous section an ad-hoc command was run to verify connectivity. Let's review some of these artifacts used to connect to Windows:

. Navigate to **Automation Execution** -> **Infrastructure** -> **Hosts**
. Notice that unlike when selecting *Inventories* as was done in the previous section, looking directly at the **Hosts** section does *NOT* allow running ad-hoc commands
+
image::20-content-windows/aap_hosts.png[AAP Hosts]
+
. Select the **windows** host
. Review the defined variables for connecting using `psrp`
+
image::20-content-windows/aap_windows_host_vars.png[Windows host variables]
+
. Navigate to **Credentials** in this same **Infrastructure** subsection under **Automation Execution**
. Select the **Windows** credential
+
image::20-content-windows/aap_windows_credential.png[Windows credential]
+
. These values should be pre-populated with {windows_admin_user} and {windows_admin_password} from the xref:environment-details.adoc[Environment Details,window=_blank] page.

=== 1.3: Connectivity Options

Some of you may be wondering what `psrp` is, rather than the typical `winrm` connection used. `psrp` is a newer protocol that has several advantages over legacy `winrm`. `psrp` does still in fact run over WinRM but uses PowerShell Remoting Protocol for execution, similar to native powershell `Invoke-Command`, rather than WinRM's SOAP based WS-Management. `psrp` also supports authentication negotiation, which allows for less explicit configuration allowing Ansible to negotiate the most effective and secure authentication transport.

Bonus lab: If desired, feel free to replace the `psrp` connection details with `winrm` for comparison

. Navigate to **Automation Execution** -> **Infrastructure** -> **Hosts**
. Select the **windows** host
. In the upper right, select **Edit Host**
. At the bottom of the page edit the **Variables** section
. For reference, here are the variables as defined using `psrp`
+
[source,yaml]
----
ansible_connection: psrp
ansible_psrp_auth: negotiate
ansible_psrp_cert_validation: ignore
----
+
. Replace with the following variables. Unlike with `psrp` which can auto-negotiate, you must specify a transport for `winrm` so pick one of the three defined below. Feel free to try all three, but only one at a time. NOTE: Additional options include `certificate` and `kerberos`, which are not configured in this lab.
+
[source,yaml]
----
ansible_connection: winrm
ansible_winrm_server_cert_validation: ignore
ansible_winrm_transport: basic|ntlm|credssp
----
+
. Before finishing this lab, ensure the `psrp` configuration is replaced.

== 2: Build Content for Managing Windows

In this section we will begin building content to setup and configure our Windows server

=== 2.1: Create a playbook directory structure

. Use `ansible-creator` to quickly scaffold a directory structure:
+
[source,bash]
----
ansible-creator init playbook red_hat_one.super_lab /projects/lab_playbooks/
----
+
. Add a new role to manage the software filebeat
+
[source,bash]
----
ansible-creator add resource role manage_filebeat /projects/lab_playbooks/collections/ansible_collections/red_hat_one/super_lab/
----
+
. Open the files at a lower level of the directory structure in order to see all of these files in VSCode by selecting the hamburger (3 dashes) menu in the top left and choosing **Files** -> **Open Folder**
. In the dialogue box enter **/projects/** then **OK**
. Dev Spaces will reload with the root as the **/projects/** directory
. Navigate in the newly created project directory `lab_playbooks` to the newly created role which will be at `/projects/lab_playbooks/collections/ansible_collections/red_hat_one/super_lab/roles/manage_filebeat`
+
image::20-content-windows/dev_spaces_created_role.png[New Role]
+
. Create a new file in the `tasks` directory along side `main.yml` called `prerequisites.yml`
. Add the following tasks to this file:
+
[source,yaml]
----
---
- name: Install .NET Framework 4.8 via Web Installer
  win_package:
    path: https://go.microsoft.com/fwlink/?linkid=2088631
    product_id: '{31C94595-568E-4545-9336-69A71B57849D}'
    arguments: /passive /norestart
  register: dotnet_install

- name: Debug .NET install
  ansible.builtin.debug:
    var: dotnet_install
    verbosity: 1

- name: Reboot when required
  ansible.windows.win_reboot:
  when: dotnet_install['reboot_required']

- name: Ensure Chocolatey is installed (requires .NET 4.8 from above)
  chocolatey.chocolatey.win_chocolatey:
    name: chocolatey
    state: present
...
----
+
. Create another new file in the `tasks` directory along side `main.yml` called `web_server.yml`
. Add the following tasks to this file:
+
[source,yaml]
----
---
- name: Install IIS Web-Server features and management tools
  ansible.windows.win_feature:
    name: Web-Server
    state: present
    include_sub_features: true
    include_management_tools: true
    
- name: Remove Default Web Site to free up Port 80
  microsoft.iis.website:
    name: "Default Web Site"
    state: absent

- name: Ensure the website physical path directory exists
  ansible.windows.win_file:
    path: C:\sites\superlab
    state: directory

- name: Copy a sample index.html file to the web root
  ansible.windows.win_template:
    src: files/index.html.j2
    dest: C:\sites\superlab\index.html
    force: true

- name: Create an IIS Website
  microsoft.iis.website:
    name: SuperLabWebsite
    physical_path: C:\sites\superlab
    application_pool: DefaultAppPool
    bindings:
      set:
        - protocol: http
          ip_address: '*'
          port: 80
    state: started
  register: website_status

- name: Display website status
  ansible.builtin.debug:
    var: website_status
    verbosity: 1
...
----
+
. Create the `files/index.html.j2` file:
+
[source,bash]
----
<!DOCTYPE html>
<html>
<head>
    <title>Server Info</title>
</head>
<body>
    <h1>Welcome to Super Lab IIS Server</h1>
    <p><strong>Machine ID:</strong> {{ ansible_facts['machine_id'] }}</p>
    <p><strong>Hostname:</strong> {{ ansible_facts['fqdn'] + '.' + ansible_facts['interfaces'][0]['dns_domain'] }}</p>
    <p><strong>Deployed on:</strong> {{ ansible_facts['date_time']['date'] }} at {{ ansible_facts['date_time']['time'] }}</p>
</body>
</html>
----
+
. Finally in the role, create a new task file called `filebeat.yml`
+
[source,yaml]
----
---
- name: Install a filebeat with Chocolatey
  chocolatey.chocolatey.win_chocolatey:
    name: filebeat
    state: present
...
----
+
. Next, edit `tasks/main.yml` and replace the contents with the following:
+
[source,yaml]
----
---
- name: Include prerequisite tasks
  ansible.builtin.include_tasks:
    file: prerequisites.yml

- name: Include web server tasks
  ansible.builtin.include_tasks:
    file: web_server.yml

- name: Include filebeat tasks
  ansible.builtin.include_tasks:
    file: filebeat.yml
...
----
+
. The file structure should look like this:
+
image::20-content-windows/role_dir_tree.png[Role Structure]
+
. Next, create a playbook to call this role at **/projects/lab_playbooks/** Replace the contents of `site.yml` with this:
+
[source,bash]
----
---
- name: Playbook to call Filebeat role
  hosts: windows
  tasks:
    - name: Call filebeat role
      ansible.builtin.include_role:
        name: red_hat_one.super_lab.manage_filebeat
...
----

=== 2.2: Test this content

IMPORTANT: ToDo: Figure out if we can test directly from Dev Spaces, otherwise using RHEL bastion might be needed to avoid a slow outer loop

== 3: Next Steps

In the next lab we will create an execution environment containing this collection and a corresponding playbook to call this new role.

== Conclusion

In this lab, you have learned:

. How to validate connectivity to Windows servers from AAP
. Using ansible-creator to scaffold directories for efficient content creation
. Create content using ansible.windows and microsoft.iis collections
. Create content to ensure prerequisites are installed including .NET and Chocolatey
. Use Chocolatey to install filebeat

== Helpful Links

For additional references, refer to the following resources:

. https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.6/html/using_ansible_development_workspaces_for_automation_content_development/index[Using Ansible Development Workspaces for Automation Content Development]
. https://docs.redhat.com/en/documentation/red_hat_openshift_dev_spaces/3.23/html/user_guide/getting-started-with-devspaces#authenticating-to-a-git-server-from-a-workspace[Authenticating to a Git server from a Workspace].
. https://github.com/jeffcpullen/devspaces-example/[Source for the Dev Space Workspace]
. https://docs.ansible.com/projects/ansible/latest/os_guide/intro_windows.html[Ansible Windows Guide]
. https://console.redhat.com/ansible/automation-hub/repo/published/microsoft/iis/[microsoft.iis collection]
