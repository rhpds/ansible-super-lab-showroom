= Lab: Content for Managing Windows Servers

[abstract]
In this lab we will develop a custom Ansible collection to manage a Windows server in our lab that will represent an example enterprise environment. We will build the content a piece at a time until the full collection is ready to be deployed. The server will be configured to run a custom website, have chocolatey software manager installed, and filebeat installed and configured.

== Learning Objectives

After completing this module, you will be able to:

. Connect and check connectivity to Windows servers from AAP
. Use `ansible.windows` and `microsoft.iis` collections
. Ensure prerequisites are installed
. Install and use Chocolatey (A Windows package manager)
. Install and configure Filebeat (a lightweight data shipper)
. Test initial content against Windows server

== 1: Managing Windows Hosts

Ansible can use a variety of connectivity options to connect to Windows. In this lab, a Windows 2019 Server has been configured using `psrp` to connect. See the link:https://docs.ansible.com/projects/ansible/latest/os_guide/intro_windows.html[Ansible documentation] for full details.

=== 1.1: Validate Connectivity to Windows host

The Windows server has been configured as a host in an inventory called **super-lab**. Verify in AAP:

. Launch the link:{aap_controller_web_url}[Ansible Automation Platform,window=_blank] web interface and login using the credentials from the xref:environment-details.adoc[Environment Details,window=_blank] page.
. From the navigation menu on the left, expand **Automation Execution** and click on **Infrastructure**.
. Under **Infrastructure** select **Inventories** which should contain an inventory called **super-lab**
+
image::20-content-windows/aap_inventories.png[AAP Inventories]
+
. Select **super-lab**
. Select **Hosts** in the top menu
. A host called **windows** will be displayed
. Select the checkbox in front of **windows** and choose **Run command** in the top middle of the screen
+
image::20-content-windows/aap_run_command.png[Run Command]
+
. For **Module** choose **win_ping** from the drop-down then **Next**
+
image::20-content-windows/aap_win_ping.png[Module]
+
. For **Execution Environment**, just choose **Next** without a selection, it will use the default EE
. For **Credential** select **Windows** then **Next**
+
image::20-content-windows/aap_run_command_credential.png[Credential]
+
. Finally, choose **Finish**. The job will run and you will be taken to the **Jobs** section
. After a few seconds a result will display which should resemble this output:
+
image::20-content-windows/aap_run_command_results.png[Results]

=== 1.2: Review Connectivity Details

In the previous section an ad-hoc command was run to verify connectivity. Let's review some of these artifacts used to connect to Windows:

. Navigate to **Automation Execution** -> **Infrastructure** -> **Hosts**
. Notice that unlike when selecting *Inventories* as was done in the previous section, looking directly at the **Hosts** section does *NOT* allow running ad-hoc commands
+
image::20-content-windows/aap_hosts.png[AAP Hosts]
+
. Select the **windows** host
. Review the defined variables for connecting using `psrp`
+
image::20-content-windows/aap_windows_host_vars.png[Windows host variables]
+
. Navigate to **Credentials** in this same **Infrastructure** subsection under **Automation Execution**
. Select the **Windows** credential
+
image::20-content-windows/aap_windows_credential.png[Windows credential]
+
. These values should be pre-populated with {windows_user} and {windows_password} from the xref:environment-details.adoc[Environment Details,window=_blank] page.

=== 1.3: Connectivity Options

Some of you may be wondering what `psrp` is, rather than the typical `winrm` connection used. `psrp` is a newer protocol that has several advantages over legacy `winrm`. `psrp` does still in fact run over WinRM but uses PowerShell Remoting Protocol for execution, similar to native powershell `Invoke-Command`, rather than WinRM's SOAP based WS-Management. `psrp` also supports authentication negotiation, which allows for less explicit configuration allowing Ansible to negotiate the most effective and secure authentication transport.

Bonus lab: If desired, feel free to replace the `psrp` connection details with `winrm` for comparison

. Navigate to **Automation Execution** -> **Infrastructure** -> **Hosts**
. Select the **windows** host
. In the upper right, select **Edit Host**
. At the bottom of the page edit the **Variables** section
. For reference, here are the variables as defined using `psrp`
+
[source,yaml,role=execute]
----
ansible_connection: psrp
ansible_psrp_auth: negotiate
ansible_psrp_cert_validation: ignore
----
+
. Replace with the following variables. Unlike with `psrp` which can auto-negotiate, you must specify a transport for `winrm` so pick one of the three defined below. Feel free to try all three, but only one at a time. NOTE: Additional options include `certificate` and `kerberos`, which are not configured in this lab.
+
[source,yaml,role=execute]
----
ansible_connection: winrm
ansible_winrm_server_cert_validation: ignore
ansible_winrm_transport: basic|ntlm|credssp
----
+
. Before finishing this lab, ensure the `psrp` configuration is replaced.

== 2: Build Content for Managing Windows

In this section we will begin building content to setup and configure our Windows server. 

NOTE: The remainder of this lab takes place inside OpenShift Dev Spaces. As a quick reminder, here is how you launch it. For full details see xref:10-platform-workspace.adoc[Module 1,window=_blank] page to login to the OpenShift console

. Launch the link:{openshift_cluster_console_url}[OpenShift Web Console,window=_blank]
. Select the **htpasswd_provider** button and use the credentials provided in the xref:environment-details.adoc[Environment Details,window=_blank] page to login to the OpenShift console
. Use the 9-block icon in the upper right to launch _Red Hat OpenShift Dev Spaces_ directly from the OpenShift console header.

=== 2.1: Build Collection and Roles

We will create a collection containing two roles to manage server configuration and software installation. Start by using `ansible-creator` to scaffold a directory structure.

[#ansible-creator-cli]
==== 2.1.1: Using the Ansible Creator CLI

NOTE: Choose either this section or <<ansible-creator-gui, 2.1.2 Using the Ansible Creator GUI>>, not both.

. If needed, ensure a terminal is open by selecting the hamburger (3 dashes) in the top left and choosing **Terminal** -> **New Terminal**
. Use `ansible-creator` to quickly scaffold a directory structure to contain a new collection:
+
[source,bash,role=execute]
----
ansible-creator init collection red_hat_one.super_lab /projects/lab_collection/
----
+
. Add two new roles to manage the software the Windows server:
+
[source,bash,role=execute]
----
for role in web_server log_shipper
  do 
    ansible-creator add resource role ${role} /projects/lab_collection/
  done
----
+
. Open the directory at a lower level of the file structure in order to see all of these files in VSCode by selecting the hamburger (3 dashes) menu in the top left and choosing **File** -> **Open Folder**
. The dialogue box should contain #/projects/# then hit **OK**
+
image::20-content-windows/dev_spaces_open_folder.png[Open Folder]
+
. Dev Spaces will reload with the root as the **/projects/** directory

Proceed to <<ansible-creator-content, 2.2: Add content to the collection>>.

[#ansible-creator-gui]
==== 2.1.2: Using the Ansible Creator UI

NOTE: Choose either this section or <<ansible-creator-cli, 2.1.1 Using the Ansible Creator CLI>>, not both.

===== 2.1.2.1: Create a Collection in the UI

Use the `ansible-creator` UI to create a collection:

. Click on the `Ansible` extension icon on the left
. Select **Collection project**
. Fill in the following details:
.. **Namespace**: #red_hat_one#
.. **Collection**: #super_lab#
.. **Init path**: #/projects/lab_collection#
. Click **Create**
. Lastly, select **Open Collection**
+
image::20-content-windows/ansible_creator_collection.png[Ansible Creator - Collection]

===== 2.1.2.2: Create Roles in the UI

Use the `ansible-creator` UI to create two new roles:

. Click on the `Ansible` extension icon on the left
. Under the **ADD** section select **Role**
. Fill in the following details:
.. **Collection root directory**: #/projects/lab_collection#
.. **Role Name**: #web_server#
. Click **Create**
+
image::20-content-windows/ansible_creator_role1.png[Ansible Creator - Collection]
+
. Without leaving this screen, keep all the other values the same other than the **Role Name**. Enter a new role called #log_shipper#
. Click **Create**
. Close this UI window
. Click on the icon to return to the file structure
+
image::20-content-windows/ansible_creator_role2.png[Ansible Creator - Collection]

Proceed to <<ansible-creator-content, 2.2: Add content to the collection>>.

[#ansible-creator-content]
=== 2.2: Add content to the collection

The following sections can be done in either the UI or CLI. Navigate in the newly created `/projects/lab_collection/roles/` directory to the newly created roles.

image::20-content-windows/collection_dir_tree.png[Collection Roles]

==== 2.2.1: Build Web Server Role

. Navigate to the directory for the `web_server` role. 
. Create a new task file in the `tasks` directory for the tasks to setup IIS:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/web_server/tasks/setup.yml"]
----
---
- name: Install IIS Web-Server features and management tools
  ansible.windows.win_feature:
    name: Web-Server
    state: present
    include_sub_features: true
    include_management_tools: true
    
- name: Remove Default Web Site to free up Port 80
  microsoft.iis.website:
    name: "Default Web Site"
    state: absent
...
----
+
. Create another new task file in that same `tasks` directory to configure the site:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/web_server/tasks/website.yml"]
----
---
- name: Ensure the website physical path directory exists
  ansible.windows.win_file:
    path: C:\sites\superlab
    state: directory

- name: Copy a sample index.html file to the web root
  ansible.windows.win_template:
    src: files/index.html.j2
    dest: C:\sites\superlab\index.html
    force: true

- name: Create an IIS Website
  microsoft.iis.website:
    name: SuperLabWebsite
    physical_path: C:\sites\superlab
    application_pool: DefaultAppPool
    bindings:
      set:
        - protocol: http
          ip: '*'
          port: 80
    state: started
  register: r_website_status

- name: Display website status
  ansible.builtin.debug:
    var: r_website_status
    verbosity: 1
...
----
+
. Create another new task file in that same `tasks` directory for validation tasks:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/web_server/tasks/validate.yml"]
----
---
- name: Test IIS locally on the Windows Server
  ansible.windows.win_uri:
    url: "http://localhost"
    return_content: yes
  register: r_local_test

- name: Debug captured result
  ansible.builtin.debug:
    var: r_local_test
    verbosity: 1
...
----
+
. Next, create the template file for the web server content:
+
[source,bash,role=execute,title="/projects/lab_collection/roles/web_server/files/index.html.j2"]
----
Welcome to Super Lab IIS Server
Machine ID {{ ansible_facts['machine_id'] }}
Hostname {{ ansible_facts['fqdn'] + '.' + ansible_facts['interfaces'][0]['dns_domain'] }}
Deployed on {{ ansible_facts['date_time']['date'] }} at {{ ansible_facts['date_time']['time'] }}
----
+
. Next, edit the main task file and replace the contents with the following:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/web_server/tasks/main.yml"]
----
---
- name: Include setup tasks
  ansible.builtin.include_tasks:
    file: setup.yml

- name: Include website tasks
  ansible.builtin.include_tasks:
    file: website.yml

- name: Include validate tasks
  ansible.builtin.include_tasks:
    file: validate.yml
...
----
+
. The file structure should look like this:
+
image::20-content-windows/web_server_role.png[Log Shipper Role]

==== 2.2.2: Build Log Shipper Role

. Navigate to the `/projects/lab_collection/roles/log_shipper/` directory
. Create a new task file in the `tasks` directory to handle setup requirements:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/log_shipper/tasks/prerequisites.yml"]
----
---
- name: Install .NET Framework 4.8 via Web Installer
  win_package:
    path: https://go.microsoft.com/fwlink/?linkid=2088631
    product_id: '{31C94595-568E-4545-9336-69A71B57849D}'
    arguments: /passive /norestart
  register: r_dotnet_install

- name: Debug .NET install
  ansible.builtin.debug:
    var: r_dotnet_install
    verbosity: 1

- name: Reboot when required
  ansible.windows.win_reboot:
  when: r_dotnet_install['reboot_required']
...
----
+
. Create a new task file in the `tasks` directory to handle setup requirements:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/log_shipper/tasks/chocolatey.yml"]
----
---
- name: Include prerequisite tasks
  ansible.builtin.include_tasks:
    file: prerequisites.yml

- name: Ensure Chocolatey is installed (requires .NET 4.8)
  chocolatey.chocolatey.win_chocolatey:
    name: chocolatey
    state: present
...
----
+
. Create another new task file in the `tasks` directory to install our log shipper, Filebeat:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/log_shipper/tasks/filebeat.yml"]
----
---
- name: Install a filebeat with Chocolatey
  chocolatey.chocolatey.win_chocolatey:
    name: filebeat
    state: present
...
----
+
. Lastly, replace main task file with the following:
+
[source,yaml,role=execute,title="/projects/lab_collection/roles/log_shipper/tasks/main.yml"]
----
---
- name: Include Chocolatey tasks
  ansible.builtin.include_tasks:
    file: chocolatey.yml

- name: Include install tasks
  ansible.builtin.include_tasks:
    file: filebeat.yml
...
----
+
. The file structure should look like this:
+
image::20-content-windows/log_shipper_role.png[Log Shipper Role]

== 3: Build Playbook directory for testing content

Now that the code is written, it is time to try running it. A few steps are needed to do that in Dev Spaces before pushing to git.

NOTE: If needed, ensure a terminal is open by selecting the hamburger (3 dashes) in the top left and choosing **Terminal** -> **New Terminal**

=== 3.1: Use Ansible Creator to create Playbook directory

For the remainder of this lab the `ansible-creator` CLI will be used for simplicity and speed. It is of course possible to create this same playbook directory from the extension UI.

. From Dev Spaces create a playbook directory:
+
[source,bash,role=execute]
----
ansible-creator init playbook red_hat_one.super_lab /projects/lab_playbooks/
----
+
NOTE: If you used the UI method earlier you may only have the collection open. Feel free to use **File** -> **Open Folder** to ensure you can access the new folder under `/projects/lab_playbooks/` in the UI if needed.
+
image::20-content-windows/lab_playbooks_dir.png[Lab Playbooks directory]

=== 3.2: Modify created directory for testing

A few steps need to be taken to modify the scaffold files to ensure they work with this lab.

==== 3.2.1: Populate the Inventory

. Comment or remove the two entries in `/projects/lab_playbooks/inventory/group_vars/all.yml`, specifically for `ansible_user` to ensure it doesn't interfere with our actual user, which will be provided via a secrets file later instead of announced to the world in inventory.
+
image::20-content-windows/group_vars_all.png[group_vars all]
+
. Modify the main inventory file and replace it with these lab details:
+
[source,yaml,role=execute,title="/projects/lab_playbooks/inventory/hosts.yml"]
----
---
all:
  children:
    windows:
      hosts:
        windows:
          ansible_host: windows.aap.svc.cluster.local
          ansible_connection: psrp
          ansible_psrp_auth: negotiate
          ansible_psrp_cert_validation: ignore
...
----

==== 3.2.1: Create secrets file

In AAP a credential is used. We will simulate that here with a file that is NOT committed to any repositories.

. Add the following to a secrets file in your home directory:
+
[source,yaml,role=execute,title="/home/user/secrets.yml"]
----
---
ansible_user: {windows_user}
ansible_password: {windows_password}
...
----
+
NOTE: You may need to do this from a terminal or open the `/home/user/` folder in the UI.

==== 3.2.1: Setup ansible.cfg

The scaffold file is fine the way it is, specifying the inventory file. However, Automation Hub entries need to be added to install collections.

. Add the following to the provided `ansible.cfg`:
+
[source,bash,role=execute,title="/projects/lab_playbooks/ansible.cfg"]
----
[galaxy]
server_list = hub, hub_validated, galaxy

[galaxy_server.hub]
url=https://console.redhat.com/api/automation-hub/content/published/
auth_url=https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
token={your_token}

[galaxy_server.hub_validated]
url=https://console.redhat.com/api/automation-hub/content/validated/
auth_url=https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
token={your_token}

[galaxy_server.galaxy]
url=https://galaxy.ansible.com
----

==== 3.2.2: Install python libraries

Install the required library for either WinRM or PSRP:

. The lab defaults to the newest protocol using PSRP:
+
[source,bash,role=execute]
----
pip install pypsrp
----
+
. If you want to use WinRM, install that library:
+
[source,bash,role=execute]
----
pip install pywinrm
----

==== 3.2.2: Configure Collections

This directory will call the roles we created. We need to install these collections in Dev Spaces:

. Modify the provided `requirements.yml` file and replace its contents:
+
[source,yaml,role=execute,title="/projects/lab_playbooks/collections/requirements.yml"]
----
---
collections:
  - chocolatey.chocolatey
  - ansible.windows
  - microsoft.iis
...
----
+
. Install the collections from the base of the `lab_playbooks` directory so it can read the `ansible.cfg` file:
+
[source,bash,role=execute]
----
cd /projects/lab_playbooks/
ansible-galaxy collection install --requirements-file collections/requirements.yml
----

==== 3.2.2: Configure Collection directory

This `ansible-creator` command required a collection name when executing. The reason is it creates a sample collection and single role embedded for use by this playbook. Since we already have our own separate collection, we will remove the provided collection and link it to `/projects/lab_collection/`.

. Remove the provided collection directory:
+
[source,bash,role=execute]
----
rm --force --recursive /projects/lab_playbooks/collections/ansible_collections/red_hat_one/super_lab/
----
+
. Now create a symbolic link to the collection we created earlier:
+
[source,bash,role=execute]
----
ln --symbolic /projects/lab_collection/ /projects/lab_playbooks/collections/ansible_collections/red_hat_one/super_lab
----
+
. If you expand `/projects/lab_playbooks/collections/ansible_collections/red_hat_one/super_lab` it show list the two roles created in `/projects/lab_collection/`
+
image::20-content-windows/playbook_dir_with_collection_link.png[Linked Collection Directory]
+
NOTE: This is only for our lab environment, this is not needed for AAP.

==== 3.2.2: Setup Playbook

. Next, replace the contents of `site.yml` with this:
+
[source,yaml,role=execute,title="/projects/lab_playbooks/site.yml"]
----
---
- name: Setup Windows Server
  hosts: windows
  tasks:
    - name: Call web server role
      ansible.builtin.include_role:
        name: red_hat_one.super_lab.web_server

    - name: Call log shipper role
      ansible.builtin.include_role:
        name: red_hat_one.super_lab.log_shipper
...
----

=== 3.3: Test Content

. Since an `ansible.cfg` and inventory are configured, ensure everything is executed from the `/projects/lab_playbooks/` directory:
+
[source,bash,role=execute]
----
cd /projects/lab_playbooks/
----
+
. Start by replicating the initial `win_ping` from AAP at the start of this lab:
+
[source,bash,role=execute]
----
ansible --module-name ansible.builtin.win_ping windows --extra-vars @/home/user/secrets.yml
----
+
. If everything was configured properly, a result identical to what was seen in AAP will be shown:
+
[source,bash,role=execute]
----
windows | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
----
+
. If connectivity worked, execute the entire playbook:
+
[source,bash,role=execute]
----
ansible-playbook site.yml --extra-vars @/home/user/secrets.yml
----
+
. If everything worked, after a few minutes the server will be configured and running both IIS and Filebeat.
. Use `curl` to test the site remotely:
+
[source,bash,role=execute]
----
$ curl http://windows.aap.svc.cluster.local
Welcome to Super Lab IIS Server
Machine ID S-1-5-21-2979851890-3482578088-4054385452
Hostname windows.lab.sandbox-5tt52-ocp4-cluster.svc.cluster.local
----

== 3: Next Steps

In the next lab we will create an execution environment containing this collection, build it and commit everything to git.

== Conclusion

In this lab, you have learned how to:

. Validate connectivity to Windows servers from AAP
. Use `ansible-creator` to scaffold the collection, roles, playbooks and inventory associated with automation targeting a Windows instance
. Create content using `ansible.windows` and `microsoft.iis` collections
. Create content to ensure prerequisites are installed including .NET and Chocolatey
. Use Chocolatey to install Filebeat
. Use Dev Spaces and Ansible Development Tools (ADT) to create, modify and test content

== Helpful Links

For additional references, refer to the following resources:

. https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.6/html/using_ansible_development_workspaces_for_automation_content_development/index[Using Ansible Development Workspaces for Automation Content Development]
. https://docs.redhat.com/en/documentation/red_hat_openshift_dev_spaces/3.23/html/user_guide/getting-started-with-devspaces#authenticating-to-a-git-server-from-a-workspace[Authenticating to a Git server from a Workspace].
. https://docs.ansible.com/projects/creator/[Ansible-Creator Documentation]
. https://github.com/jeffcpullen/devspaces-example/[Source for the Dev Space Workspace]
. https://docs.ansible.com/projects/ansible/latest/os_guide/intro_windows.html[Ansible Windows Guide]
. https://console.redhat.com/ansible/automation-hub/repo/published/microsoft/iis/[microsoft.iis collection]
. https://www.elastic.co/beats/filebeat[Filebeat]
. https://chocolatey.org/[Chocolatey]