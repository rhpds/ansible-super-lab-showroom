= Lab: Ansible Automation Platform as Code on OpenShift

In this lab, you will learn how to deploy and configure Red Hat Ansible Automation Platform (AAP) on an OpenShift cluster using the "Configuration as Code" (CaC) approach. We will utilize a validated collection designed to automate the installation via the AAP Operator.

== Prerequisites

Before starting this lab, ensure you have access to:

* *Red Hat OpenShift Container Platform*: A running cluster where you have `cluster-admin` privileges.
* *Red Hat Dev Spaces*: Your workspace environment for editing code and running terminal commands.

== Overview

Installing AAP as code allows for repeatable, version-controlled infrastructure. We will create a very simple playbook to call a role provided by the validated collection `infra.aap_configuration` that interacts with the OpenShift API and the AAP Operator.

== 1: Setup Environment

=== 1.1: Prepare your Dev Spaces Environment

First, open your Red Hat Dev Spaces instance and initialize your workspace.

. Open the terminal in Dev Spaces.
. Create a new directory for this project:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
mkdir --parents --verbose /projects/aap-ops 
cd /projects/aap-ops
----

=== 1.2: Create a Secrets file

Create a separate secrets file as a best practice:

[source,yaml,role=execute,subs="verbatim,attributes",title="/projects/aap-ops/secrets.yml"]
----
---
openshift_username: '{openshift_cluster_admin_username}'
openshift_password: '{openshift_cluster_admin_password}'
...
----

=== 1.3: Create Playbook

Create a playbook to call the `infra.aap_utilities.aap_ocp_install` role with task vars defining vital values:

[source,bash,role=execute,subs="verbatim,attributes",title="/projects/aap-ops/install_aap.yml"]
----
---
- name: Install AAP on OCP
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Include AAP OCP Install role
      ansible.builtin.include_role:
        name: infra.aap_utilities.aap_ocp_install
      vars:
        aap_ocp_install_connection:
          host: '{openshift_api_server_url}'
          username: '{{ openshift_username }}'
          password: '{{ openshift_password }}'
          validate_certs: false
        aap_ocp_install_namespace: aap-as-code
        aap_ocp_install_operator:
          channel: "stable-2.6"
        aap_ocp_install_platform:
          instance_name: aap
        aap_ocp_install_controller:
          install: true
        aap_ocp_install_eda:
          install: false
        aap_ocp_install_hub:
          install: false
          file_storage_size: 100Gi
          file_storage_storage_class: ocs-external-storagecluster-cephfs
        aap_ocp_install_lightspeed:
          install: false
...
----

NOTE: The more components installed at once, the longer it will take. Feel free to start small and re-run with more components enabled to iteratively deploy components.

=== 1.4: Setup ansible.cfg

. If you review the documentation this role specifies requirements we need to install in this environment.
. Create a simple `ansible.cfg` to authenticate to upstream Automation Hub:
. Obtain a token from https://console.redhat.com/ansible/automation-hub/token/[Automation Hub,window=_blank]
. Under **Offline Token** click **Load Token** and copy this token and store it somewhere secure as it cannot be displayed again
+
NOTE: For additional information see https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.6/html/managing_automation_content/managing-cert-valid-content#token-management-hub_cloud-sync[Managing Automation Content Documentation,window=_blank]
+
[source,yaml,role=execute,subs="verbatim,attributes,callouts",title="Custom AAP Deployment",title="/projects/aap-ops/ansible.cfg"]
----
[galaxy]
server_list = hub, hub_validated, galaxy

[galaxy_server.hub]
url=https://console.redhat.com/api/automation-hub/content/published/
auth_url=https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
token=#YOUR_TOKEN#

[galaxy_server.hub_validated]
url=https://console.redhat.com/api/automation-hub/content/validated/
auth_url=https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
token=#YOUR_TOKEN#

[galaxy_server.galaxy]
url=https://galaxy.ansible.com
----
+
NOTE: Be sure to replace #YOUR_TOKEN# with the token from step 3.

=== 1.5: Install Collections

Install required collections:

[source,bash,role=execute,subs="verbatim,attributes",title="/projects/aap-ops/install_aap.yml"]
----
ansible-galaxy collection install infra.aap_utilities redhat.openshift
----

[source,output]
----
ansible-galaxy collection install redhat.openshift infra.aap_utilities
Starting galaxy collection install process
Process install dependency map
Starting collection install process
Downloading https://console.redhat.com/api/automation-hub/v3/plugin/ansible/content/published/collections/artifacts/redhat-openshift-5.0.0.tar.gz to /home/user/.ansible/tmp/ansible-local-57063izw_zm8z/tmpfxmq2iwn/redhat-openshift-5.0.0-cywjtcc3
Installing 'redhat.openshift:5.0.0' to '/home/user/.ansible/collections/ansible_collections/redhat/openshift'
Downloading https://console.redhat.com/api/automation-hub/v3/plugin/ansible/content/published/collections/artifacts/kubernetes-core-6.2.0.tar.gz to /home/user/.ansible/tmp/ansible-local-57063izw_zm8z/tmpfxmq2iwn/kubernetes-core-6.2.0-xyd0elsb
redhat.openshift:5.0.0 was installed successfully
Installing 'kubernetes.core:6.2.0' to '/home/user/.ansible/collections/ansible_collections/kubernetes/core'
Downloading https://console.redhat.com/api/automation-hub/v3/plugin/ansible/content/validated/collections/artifacts/infra-aap_utilities-2.8.0.tar.gz to /home/user/.ansible/tmp/ansible-local-57063izw_zm8z/tmpfxmq2iwn/infra-aap_utilities-2.8.0-24n1tg51
kubernetes.core:6.2.0 was installed successfully
Installing 'infra.aap_utilities:2.8.0' to '/home/user/.ansible/collections/ansible_collections/infra/aap_utilities'
Downloading https://console.redhat.com/api/automation-hub/v3/plugin/ansible/content/published/collections/artifacts/ansible-posix-2.1.0.tar.gz to /home/user/.ansible/tmp/ansible-local-57063izw_zm8z/tmpfxmq2iwn/ansible-posix-2.1.0-foqzpncl
infra.aap_utilities:2.8.0 was installed successfully
Installing 'ansible.posix:2.1.0' to '/home/user/.ansible/collections/ansible_collections/ansible/posix'
ansible.posix:2.1.0 was installed successfully
----

=== 1.6: Install Python Libraries

Install required python libraries:

[source,bash,role=execute,subs="verbatim,attributes"]
----
pip install requests requests-oauthlib kubernetes
----

[source,output]
----
Collecting requests
  Using cached requests-2.32.5-py3-none-any.whl (64 kB)
Collecting requests-oauthlib
  Using cached requests_oauthlib-2.0.0-py2.py3-none-any.whl (24 kB)
Collecting kubernetes
  Using cached kubernetes-35.0.0-py2.py3-none-any.whl (2.0 MB)
Collecting charset_normalizer<4,>=2
  Using cached charset_normalizer-3.4.4-cp311-cp311-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (151 kB)
Collecting idna<4,>=2.5
  Using cached idna-3.11-py3-none-any.whl (71 kB)
Collecting urllib3<3,>=1.21.1
  Using cached urllib3-2.6.3-py3-none-any.whl (131 kB)
Collecting certifi>=2017.4.17
  Using cached certifi-2026.1.4-py3-none-any.whl (152 kB)
Collecting oauthlib>=3.0.0
  Using cached oauthlib-3.3.1-py3-none-any.whl (160 kB)
Collecting six>=1.9.0
  Using cached six-1.17.0-py2.py3-none-any.whl (11 kB)
Collecting python-dateutil>=2.5.3
  Using cached python_dateutil-2.9.0.post0-py2.py3-none-any.whl (229 kB)
Requirement already satisfied: pyyaml>=5.4.1 in ./.venv/lib64/python3.11/site-packages (from kubernetes) (6.0.3)
Collecting websocket-client!=0.40.0,!=0.41.*,!=0.42.*,>=0.32.0
  Using cached websocket_client-1.9.0-py3-none-any.whl (82 kB)
Collecting durationpy>=0.7
  Using cached durationpy-0.10-py3-none-any.whl (3.9 kB)
Installing collected packages: durationpy, websocket-client, urllib3, six, oauthlib, idna, charset_normalizer, certifi, requests, python-dateutil, requests-oauthlib, kubernetes
Successfully installed certifi-2026.1.4 charset_normalizer-3.4.4 durationpy-0.10 idna-3.11 kubernetes-35.0.0 oauthlib-3.3.1 python-dateutil-2.9.0.post0 requests-2.32.5 requests-oauthlib-2.0.0 six-1.17.0 urllib3-2.6.3 websocket-client-1.9.0

[notice] A new release of pip available: 22.3.1 -> 25.3
[notice] To update, run: pip install --upgrade pip
----

== 2: Run Playbook

=== 2.1: First Attempt

. Now try to run the playbook. This will fail, can you spot why?
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-playbook install_aap.yml \
  --verbose \
  --verbose \
  --extra-vars @secrets.yml
----
+
[source,output]
----
ansible-playbook [core 2.19.3]
  config file = /projects/aap-ops/ansible.cfg
  configured module search path = ['/home/user/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.11/site-packages/ansible
  ansible collection location = /home/user/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible-playbook
  python version = 3.11.13 (main, Aug 21 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-11)] (/usr/bin/python3.11)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
Using /projects/aap-ops/ansible.cfg as config file
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAYBOOK: install_aap.yml ******************************************************
1 plays in install_aap.yml

PLAY [Install AAP on OCP] ******************************************************

TASK [Include AAP OCP Install role] ********************************************
task path: /projects/aap-ops/install_aap.yml:27
included: infra.aap_utilities.aap_ocp_install for localhost

TASK [infra.aap_utilities.aap_ocp_install : Include pre-validation tasks] ******
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/main.yml:2
included: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/pre-validate.yml for localhost

...

TASK [infra.aap_utilities.aap_ocp_install : Ensure no validation errors found] *****************************************************************************************************************
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/pre-validate.yml:135
[ERROR]: Task failed: Action failed: ['The following errors must be fixed to continue:', ["aap_ocp_install_namespace must be a lowercase RFC 1123 label consisting of lower case alphanumeric characters or '-', and must start and end with an alphanumeric character (e.g. 'my-name',  or '123-abc'"]]
Origin: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/pre-validate.yml:135:3

133     - (( 'eda' in ansible_run_tags ) or ( 'all' in ansible_run_tags and aap_ocp_install_eda is defined )) and not...
134
135 - name: Ensure no validation errors found
      ^ column 3

fatal: [localhost]: FAILED! => {
    "msg": [
        "The following errors must be fixed to continue:",
        [
            "aap_ocp_install_namespace must be a lowercase RFC 1123 label consisting of lower case alphanumeric characters or '-', and must start and end with an alphanumeric character (e.g. 'my-name',  or '123-abc'"
        ]
    ]
}

PLAY RECAP *************************************************************************************************************************************************************************************
localhost
----
+
. This is a known issue as of the current collection release (2.8.0) which will not work with Ansible 2.19 or higher. With the double `--verbose` level, we can also see the version when the playbook executes. Review what version you are using:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible --version
----
+
----
ansible [core 2.19.3]
  config file = None
  configured module search path = ['/home/user/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.11/site-packages/ansible
  ansible collection location = /home/user/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/local/bin/ansible
  python version = 3.11.13 (main, Aug 21 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-11)] (/usr/bin/python3.11)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
----
. This is a currently known issue, but is a great opportunity to explore this scenario. This will be addressed in the next section.
+
NOTE: The rest of this lab works with ansible-core 2.19, only config as code labs are affected.

=== 2.2: Setup Python Virtual Environment

. This is a currently known issue, but is a great opportunity to explore this scenario. Create a virtual environment to downgrade the version of `ansible-core` for this run.
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
python3 -m venv .venv
source .venv/bin/activate
----
+
[source,output]
----
(.venv) bash-5.1$
----
+
NOTE: Your prompt changes to reflect the virtual environment.
+
. Install `ansible-core` version 2.18:
+
----
pip install ansible-core==2.18
Collecting ansible-core==2.18
  Using cached ansible_core-2.18.0-py3-none-any.whl (2.2 MB)
Collecting jinja2>=3.0.0
  Using cached jinja2-3.1.6-py3-none-any.whl (134 kB)
Collecting PyYAML>=5.1
  Using cached pyyaml-6.0.3-cp311-cp311-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (806 kB)
Collecting cryptography
  Using cached cryptography-46.0.3-cp311-abi3-manylinux_2_34_x86_64.whl (4.5 MB)
Collecting packaging
  Using cached packaging-26.0-py3-none-any.whl (74 kB)
Collecting resolvelib<1.1.0,>=0.5.3
  Using cached resolvelib-1.0.1-py2.py3-none-any.whl (17 kB)
Collecting MarkupSafe>=2.0
  Using cached markupsafe-3.0.3-cp311-cp311-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (22 kB)
Collecting cffi>=2.0.0
  Using cached cffi-2.0.0-cp311-cp311-manylinux2014_x86_64.manylinux_2_17_x86_64.whl (215 kB)
Collecting pycparser
  Using cached pycparser-3.0-py3-none-any.whl (48 kB)
Installing collected packages: resolvelib, PyYAML, pycparser, packaging, MarkupSafe, jinja2, cffi, cryptography, ansible-core
Successfully installed MarkupSafe-3.0.3 PyYAML-6.0.3 ansible-core-2.18.0 cffi-2.0.0 cryptography-46.0.3 jinja2-3.1.6 packaging-26.0 pycparser-3.0 resolvelib-1.0.1

[notice] A new release of pip available: 22.3.1 -> 25.3
[notice] To update, run: pip install --upgrade pip
----
+
. Verify the version again:
+
[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible --version
----
+
----
ansible [core 2.18.0]
  config file = /projects/aap-ops/ansible.cfg
  configured module search path = ['/home/user/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /projects/aap-ops/.venv/lib64/python3.11/site-packages/ansible
  ansible collection location = /home/user/.ansible/collections:/usr/share/ansible/collections
  executable location = /projects/aap-ops/.venv/bin/ansible
  python version = 3.11.13 (main, Aug 21 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-11)] (/projects/aap-ops/.venv/bin/python3)
  jinja version = 3.1.6
  libyaml = True
----
+
NOTE: In case you still see version 2.19 run the command `hash -r` and try again.

=== 2.3 Re-run Playbook

Now, run the playbook once again and it should succeed:

[source,bash,role=execute,subs="verbatim,attributes"]
----
ansible-playbook install_aap.yml \
  --verbose \
  --verbose \
  --extra-vars @secrets.yml
----

[source,output]
----
ansible-playbook [core 2.18.0]
  config file = /projects/aap-ops/ansible.cfg
  configured module search path = ['/home/user/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /projects/aap-ops/.venv/lib64/python3.11/site-packages/ansible
  ansible collection location = /home/user/.ansible/collections:/usr/share/ansible/collections
  executable location = /projects/aap-ops/.venv/bin/ansible-playbook
  python version = 3.11.13 (main, Aug 21 2025, 00:00:00) [GCC 11.5.0 20240719 (Red Hat 11.5.0-11)] (/projects/aap-ops/.venv/bin/python3)
  jinja version = 3.1.6
  libyaml = True
Using /projects/aap-ops/ansible.cfg as config file
Skipping callback 'default', as we already have a stdout callback.
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAYBOOK: install_aap.yml ******************************************************
1 plays in install_aap.yml

PLAY [Install AAP on OCP] ******************************************************

TASK [Include AAP OCP Install role] ********************************************
task path: /projects/aap-ops/install_aap.yml:27
included: infra.aap_utilities.aap_ocp_install for localhost

TASK [infra.aap_utilities.aap_ocp_install : Include pre-validation tasks] ******
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/main.yml:2
included: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/pre-validate.yml for localhost

...

TASK [infra.aap_utilities.aap_ocp_install : Include Ansible Automation Platform controller install tasks] ****************************************
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/main.yml:42
skipping: [localhost] => {"changed": false, "false_condition": "aap_ocp_install_controller is defined and not __aap_ocp_install_25_install", "skip_reason": "Conditional result was False"}

TASK [infra.aap_utilities.aap_ocp_install : Include Ansible Automation Platform hub install tasks] ***********************************************
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/main.yml:52
skipping: [localhost] => {"changed": false, "false_condition": "aap_ocp_install_hub is defined and not __aap_ocp_install_25_install", "skip_reason": "Conditional result was False"}

TASK [infra.aap_utilities.aap_ocp_install : Include Ansible Automation Platform EDA install tasks] ***********************************************
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/main.yml:62
skipping: [localhost] => {"changed": false, "false_condition": "aap_ocp_install_eda is defined and not __aap_ocp_install_25_install", "skip_reason": "Conditional result was False"}

TASK [infra.aap_utilities.aap_ocp_install : Include OpenShift finalization tasks] ****************************************************************
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/main.yml:73
included: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/finalization.yml for localhost

TASK [infra.aap_utilities.aap_ocp_install : If login succeeded revoke OpenShift API token] *******************************************************
task path: /home/user/.ansible/collections/ansible_collections/infra/aap_utilities/roles/aap_ocp_install/tasks/finalization.yml:2
ok: [localhost] => {"changed": false, "k8s_auth": {}, "openshift_auth": {}}

PLAY RECAP ***************************************************************************************************************************************
localhost    
----

NOTE: The installation process can take 10-15 minutes as OpenShift all the resources, depending on which components are enabled in the playbook.

== 5: Verify the Deployment

Once the playbook completes, verify that the AAP components are running in OpenShift.

. Launch the link:{openshift_cluster_console_url}[OpenShift Web Console,window=_blank]
. Navigate to **Ecosystem** on the left hand navigation -> **Installed Operators**.
. Next to the `Project:` dropdown in the top left, ensure `aap-as-code` is the project shown.
. Click on the `Ansible Automation Platform` operator.
. In the toolbar, click on `All instances`.
. Verify installation was completed.
+
image::13-platform-aap_on_ocp_cac/installed-operators-aap.png[Installed Operators in the AAP Project]
+
. Navigate to *Networking* -> *Routes*
. Open the URL under *Location* for the *aap* instance in a new window
. Still within OpenShift, navigate to *Workloads* -> *Secrets*
. Click on *aap-admin-password*
. Scroll to the bottom and copy the password
. Use `admin` as the username and the secret copied to login and verify
. Feel free as a bonus to modify your playbook and deploy additional items

== 6: Reset the Environment

Before completing this lab, deactivate the python virtual environment:

[source,bash,role=execute,subs="verbatim,attributes"]
----
deactivate
----

== Summary

You have successfully deployed Ansible Automation Platform using a Configuration as Code pattern. This method ensures that your automation infrastructure remains consistent and can be easily redeployed or updated through Git-driven workflows.

== Helpful Links:

* https://console.redhat.com/ansible/automation-hub/repo/validated/infra/aap_utilities/
* https://console.redhat.com/ansible/automation-hub/repo/validated/infra/aap_utilities/content/role/aap_ocp_install/